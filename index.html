<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="增肌训练计划，提供详细的训练动作指导、一周训练5天，休息2天，支持循环显示，包含进度记录、饮食建议等功能。">
    <meta name="keywords" content="增肌, 训练计划, 杠铃肩推, 深蹲, 硬拉, 卧推, 健身, PWA">
    <meta name="author" content="健身爱好者">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="manifest" href="manifest.json">
    <title>增肌训练计划 - 一周循环</title>
    <style>
        /* 保留原有样式 */
        :root {
            --primary-color: #007BFF;
            --hover-color: #0056b3;
            --background-color: #f4f4f4;
            --details-bg: #e8f0ff;
            --table-border: #ddd;
            --rest-day-bg: #f8d7da;
            --rest-day-text: #5a1a20;
            --success-color: #28a745;
            --warning-color: #ffc107;
        }

        /* 暗黑模式样式 */
        body.dark-mode {
            --primary-color: #66b0ff;
            --hover-color: #99c7ff;
            --background-color: #1a1a1a;
            --details-bg: #2c3e50;
            --table-border: #444;
            --rest-day-bg: #5c2d2d;
            --rest-day-text: #f5c6cb;
            --success-color: #2ecc71;
            --warning-color: #f1c40f;
        }

        /* 登录/注册表单样式 */
        .login-form, .register-form {
            max-width: 400px;
            margin: 20px auto;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            display: none;
        }

        .login-form.active, .register-form.active {
            display: block;
        }

        .login-form input, .register-form input {
            width: 100%;
            padding: 8px;
            margin: 10px 0;
            border: 1px solid var(--table-border);
            border-radius: 5px;
        }

        .login-form button, .register-form button {
            background: var(--success-color);
            color: white;
            padding: 10px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        /* 其余原有样式保持不变 */
    </style>
</head>
<body>
    <div class="container">
        <button id="theme-toggle" class="exercise">切换深色模式</button>
        <h2>增肌训练计划 - 一周循环</h2>
        <div class="login-form">
            <h3>登录</h3>
            <input type="text" id="login-username" placeholder="用户名" required>
            <input type="password" id="login-password" placeholder="密码" required>
            <button onclick="login()">登录</button>
            <p>没有账号？<a href="#" onclick="showRegister()">注册</a></p>
        </div>
        <div class="register-form">
            <h3>注册</h3>
            <input type="text" id="register-username" placeholder="用户名" required>
            <input type="password" id="register-password" placeholder="密码" required>
            <input type="number" id="register-weight" placeholder="当前体重 (kg)" required>
            <input type="number" id="register-height" placeholder="身高 (cm)" required>
            <button onclick="register()">注册</button>
            <p>已有账号？<a href="#" onclick="showLogin()">登录</a></p>
        </div>
        <div id="user-welcome" style="display: none;">
            <h3>欢迎, <span id="user-name"></span>!</h3>
            <button class="exercise" onclick="logout()">退出登录</button>
            <p>体重: <span id="user-weight"></span> kg</p>
            <p>身高: <span id="user-height"></span> cm</p>
        </div>

        <!-- 训练计划表格保持不变 -->
        <table>
            <!-- 保留原有表格内容 -->
        </table>

        <button class="exercise" aria-expanded="false" aria-controls="progress_summary" aria-label="展开训练进度查看详情" onclick="toggleDetails('progress_summary')">查看训练进度</button>
        <div id="progress_summary" class="details" aria-hidden="true">
            <p>以下是您记录的训练进度。</p>
            <div id="progress_data"></div>
            <button class="exercise" onclick="clearProgress()">清除所有记录</button>
        </div>
    </div>

    <script>
        let db;
        const DB_NAME = 'FitnessAppDB';
        const USER_STORE = 'users';
        const PROGRESS_STORE = 'progress';
        let currentUser = null;

        function initDB() {
            const request = indexedDB.open(DB_NAME, 1);
            request.onupgradeneeded = event => {
                db = event.target.result;
                db.createObjectStore(USER_STORE, { keyPath: 'username' });
                db.createObjectStore(PROGRESS_STORE, { keyPath: 'id', autoIncrement: true });
            };
            request.onsuccess = event => {
                db = event.target.result;
                checkLoginStatus();
            };
            request.onerror = event => {
                console.error('IndexedDB 初始化失败:', event.target.error);
            };
        }

        function showLogin() {
            document.querySelector('.login-form').classList.add('active');
            document.querySelector('.register-form').classList.remove('active');
        }

        function showRegister() {
            document.querySelector('.register-form').classList.add('active');
            document.querySelector('.login-form').classList.remove('active');
        }

        function register() {
            const username = document.getElementById('register-username').value;
            const password = document.getElementById('register-password').value;
            const weight = document.getElementById('register-weight').value;
            const height = document.getElementById('register-height').value;

            if (!username || !password || !weight || !height) {
                alert('请填写所有字段！');
                return;
            }

            const transaction = db.transaction([USER_STORE], 'readwrite');
            const store = transaction.objectStore(USER_STORE);
            const request = store.get(username);

            request.onsuccess = () => {
                if (request.result) {
                    alert('用户名已存在！');
                } else {
                    const user = {
                        username,
                        password, // 注意：实际应用中应加密密码
                        weight,
                        height,
                        progress: []
                    };
                    store.add(user);
                    transaction.oncomplete = () => {
                        alert('注册成功！请登录。');
                        showLogin();
                        document.querySelector('.register-form').reset();
                    };
                }
            };
        }

        function login() {
            const username = document.getElementById('login-username').value;
            const password = document.getElementById('login-password').value;

            const transaction = db.transaction([USER_STORE], 'readonly');
            const store = transaction.objectStore(USER_STORE);
            const request = store.get(username);

            request.onsuccess = () => {
                const user = request.result;
                if (user && user.password === password) {
                    currentUser = user;
                    document.querySelector('.login-form').classList.remove('active');
                    document.getElementById('user-name').textContent = username;
                    document.getElementById('user-weight').textContent = user.weight;
                    document.getElementById('user-height').textContent = user.height;
                    document.getElementById('user-welcome').style.display = 'block';
                    displayProgress();
                } else {
                    alert('用户名或密码错误！');
                }
            };
        }

        function logout() {
            currentUser = null;
            document.getElementById('user-welcome').style.display = 'none';
            showLogin();
        }

        function checkLoginStatus() {
            if (currentUser) {
                document.getElementById('user-name').textContent = currentUser.username;
                document.getElementById('user-weight').textContent = currentUser.weight;
                document.getElementById('user-height').textContent = currentUser.height;
                document.getElementById('user-welcome').style.display = 'block';
            } else {
                showLogin();
            }
        }

        function saveProgress(event, day) {
            event.preventDefault();
            if (!currentUser) {
                alert('请先登录！');
                return;
            }

            const form = event.target;
            const button = form.querySelector('button');
            button.classList.add('loading');
            button.disabled = true;

            const formData = new FormData(form);
            const weight = formData.get(`${day}_weight`);
            const sets = formData.get(`${day}_sets`);
            const notes = formData.get('notes');

            if (!weight || isNaN(weight) || weight <= 0) {
                alert('请输入有效的重量（正数）！');
                button.classList.remove('loading');
                button.disabled = false;
                return;
            }

            const setsPattern = /^\d+x\d+$/;
            if (!setsPattern.test(sets)) {
                alert('请输入有效的组数/次数，格式如 4x10！');
                button.classList.remove('loading');
                button.disabled = false;
                return;
            }

            const progress = {
                day,
                weight,
                sets,
                notes,
                date: new Date().toLocaleString(),
                user: currentUser.username
            };

            const transaction = db.transaction([PROGRESS_STORE], 'readwrite');
            const store = transaction.objectStore(PROGRESS_STORE);
            store.add(progress);

            transaction.oncomplete = () => {
                button.classList.remove('loading');
                button.disabled = false;
                alert('进度已保存！');
                form.reset();
                displayProgress();
                updateUserProgress(progress);
            };
        }

        function updateUserProgress(progress) {
            const transaction = db.transaction([USER_STORE], 'readwrite');
            const store = transaction.objectStore(USER_STORE);
            const request = store.get(currentUser.username);

            request.onsuccess = () => {
                const user = request.result;
                user.progress.push(progress);
                store.put(user);
            };
        }

        function displayProgress() {
            if (!currentUser) {
                document.getElementById('progress_data').innerHTML = '<p>请登录以查看进度。</p>';
                return;
            }

            const transaction = db.transaction([PROGRESS_STORE], 'readonly');
            const store = transaction.objectStore(PROGRESS_STORE);
            const request = store.getAll();

            request.onsuccess = () => {
                const progressData = request.result.filter(p => p.user === currentUser.username);
                const progressDiv = document.getElementById('progress_data');
                progressDiv.innerHTML = '';

                const groupedData = {};
                progressData.forEach(entry => {
                    if (!groupedData[entry.day]) {
                        groupedData[entry.day] = [];
                    }
                    groupedData[entry.day].push(entry);
                });

                for (const day in groupedData) {
                    progressDiv.innerHTML += `<h3>${day}</h3>`;
                    groupedData[day].forEach((entry, index) => {
                        progressDiv.innerHTML += `
                            <p>记录 ${index + 1} (${entry.date}):</p>
                            <p>重量: ${entry.weight} kg</p>
                            <p>组数/次数: ${entry.sets}</p>
                            <p>感受: ${entry.notes || '无'}</p>
                            <hr>
                        `;
                    });
                }
            };
        }

        function clearProgress() {
            if (confirm('确定要清除所有训练进度吗？此操作不可恢复。')) {
                const transaction = db.transaction([PROGRESS_STORE], 'readwrite');
                const store = transaction.objectStore(PROGRESS_STORE);
                store.clear();
                transaction.oncomplete = () => {
                    displayProgress();
                    alert('所有记录已清除！');
                    if (currentUser) {
                        updateUserProgress([]);
                    }
                };
            }
        }

        // 主题切换和 PWA 注册保持不变
        window.addEventListener('load', () => {
            initDB();
            displayProgress();

            document.getElementById('theme-toggle').addEventListener('click', () => {
                document.body.classList.toggle('dark-mode');
                const isDarkMode = document.body.classList.contains('dark-mode');
                localStorage.setItem('theme', isDarkMode ? 'dark' : 'light');
                document.getElementById('theme-toggle').textContent = isDarkMode ? '切换浅色模式' : '切换深色模式';
            });

            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'dark') {
                document.body.classList.add('dark-mode');
                document.getElementById('theme-toggle').textContent = '切换浅色模式';
            }

            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('/service-worker.js')
                    .then(registration => console.log('Service Worker 注册成功:', registration))
                    .catch(error => console.log('Service Worker 注册失败:', error));
            }
        });

        // 展开/折叠详情功能保持不变
        function toggleDetails(id) {
            const details = document.getElementById(id);
            const button = document.querySelector(`[aria-controls="${id}"]`);
            const isExpanded = button.getAttribute("aria-expanded") === "true";
            button.setAttribute("aria-expanded", !isExpanded);
            details.setAttribute("aria-hidden", isExpanded);
        }
    </script>
</body>
</html>